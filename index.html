<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCG Pack Opening Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Card Styles */
        .card-container {
            perspective: 1000px;
        }
        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-container.flipped .card {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 0.5rem;
        }
        .card-front {
            transform: rotateY(180deg);
        }
        .card-front:hover {
            transform: rotateY(180deg) translateY(-10px) rotateX(5deg);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .card-back {
            background: #374151; /* gray-700 */
            border: 4px solid #4b5563; /* gray-600 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .card-back:hover {
            transform: translateY(-5px);
            background: #4b5563;
        }
        .card-back-logo {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937; /* gray-800 */
        }
        
        .card-face.foil {
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.6);
            overflow: hidden;
        }

        .card-face.foil::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.1) 35%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0.1) 65%, rgba(255,255,255,0.1) 100%);
            transform: rotate(30deg);
            animation: foil-sheen 3s infinite linear;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes foil-sheen {
            0% { transform: translateX(-75%) translateY(-75%) rotate(30deg); }
            100% { transform: translateX(75%) translateY(75%) rotate(30deg); }
        }
        .rarity-common { border-color: #6b7280; }
        .rarity-uncommon { border-color: #60a5fa; }
        .rarity-rare { border-color: #facc15; }
        .rarity-mythic { border-color: #f97316; }

        .pack {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .pack:hover {
            transform: scale(1.05);
        }
        
        /* Pack Opening Modal */
        #pack-opening-modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }
        .pack-art-container {
            position: relative;
            width: 200px;
            height: 300px;
            user-select: none;
        }
        .pack-art {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #4a5568;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            border: 4px solid #2d3748;
            overflow: hidden;
            cursor: grab;
        }
        .pack-art-back {
            z-index: 1;
        }
        .pack-art-front {
            z-index: 2;
            clip-path: inset(0 0 0 0); /* Initially fully visible */
            transition: clip-path 0.1s linear;
        }
        .pack-art-front:active {
            cursor: grabbing;
        }
        .pack-art-tear-off {
            z-index: 3;
            clip-path: inset(0 100% 0 0);
            height: 10%;
            pointer-events: none;
        }
        .pack-opening-text {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 1rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }


        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">
    
    <!-- Pack Opening Modal -->
    <div id="pack-opening-modal">
        <div class="pack-art-container">
            <div class="pack-art pack-art-back">
                <span>OPENED</span>
            </div>
            <div class="pack-art pack-art-front" id="pack-art-tearable">
                <span id="pack-art-set-name">Set Name</span>
            </div>
            <div class="pack-art pack-art-tear-off" id="pack-art-tear-off">
                 <span id="pack-art-set-name-torn"></span>
            </div>
            <div class="pack-opening-text">Click and Drag to Tear</div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">TCG Pack Simulator</h1>
            <p class="text-gray-400 mt-2">Open virtual packs and complete your collection!</p>
        </header>

        <main>
            <!-- Set Selection and Pack Buying -->
            <section id="pack-selection" class="bg-gray-800 rounded-2xl p-6 mb-8 shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-center">Choose a Set</h2>
                <div class="flex flex-wrap justify-center items-center gap-4">
                    <select id="set-selector" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <!-- Options will be populated by JS -->
                    </select>
                    <button id="buy-pack-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Buy 1 Pack</button>
                    <button id="buy-box-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Buy Booster Box (30 Packs)</button>
                </div>
                <div id="unopened-packs-container" class="mt-6 text-center">
                    <h3 class="text-xl font-semibold mb-2">Your Packs</h3>
                    <div id="unopened-packs-display" class="flex flex-wrap justify-center gap-4 p-4 bg-gray-900/50 rounded-lg min-h-[100px]">
                        <!-- Unopened packs will be displayed here -->
                    </div>
                </div>
            </section>

            <!-- Opened Pack Display -->
            <section id="opened-pack-container" class="bg-gray-800 rounded-2xl p-6 mb-8 shadow-lg min-h-[300px]">
                 <h2 class="text-2xl font-semibold mb-4 text-center">Opened Pack</h2>
                 <div id="opened-pack-display" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-4">
                    <!-- Cards from the opened pack will be displayed here -->
                 </div>
            </section>

            <!-- Collection Viewing Area -->
            <section id="collection-container" class="bg-gray-800 rounded-2xl p-6 shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">My Collection</h2>
                    <div class="flex items-center gap-4 mt-4 md:mt-0">
                        <label for="collection-set-selector" class="text-sm">View Set:</label>
                        <select id="collection-set-selector" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <!-- Options will be populated by JS -->
                        </select>
                         <div id="collection-progress" class="text-sm"></div>
                    </div>
                </div>
                <div id="collection-display" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-8 gap-4 max-h-[600px] overflow-y-auto p-4 bg-gray-900/50 rounded-lg">
                    <!-- User's collection will be displayed here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- DATA DEFINITIONS ---
        const TCG_SETS = {
            "Alpha_Venture": {
                name: "Alpha Venture",
                totalCards: 60,
                packSize: 12,
                boosterBoxSize: 30,
                packComposition: { common: 7, uncommon: 3, rare: 1 },
                mythicChance: 1 / 8,
                foilChance: 1 / 6,
                cards: {
                    common: ["Goblin Grunt", "Forest Sprite", "River Drake", "Stone Golem", "Zealous Knight", "Shadow Stalker", "Arcane Apprentice", "Healing Salve", "Quick Strike", "Mountain Goat", "Swamp Rat", "Floating Eye", "Armored Guard", "Village Blacksmith", "Wandering Monk"],
                    uncommon: ["Ogre Brute", "Elven Archer", "Kraken's Tentacle", "Gargoyle Sentry", "Captain of the Guard", "Vampire Initiate", "Fireball", "Counterspell", "Holy Light", "Rockslide", "Poison Cloud", "Mind Twist", "Reinforced Armor", "Masterwork Sword", "Amulet of Vigor"],
                    rare: ["Hill Giant", "Greenwood Protector", "Sea Serpent", "Obsidian Golem", "Champion of the Realm", "Lich's Familiar", "Meteor Shower", "Time Warp", "Divine Intervention", "Earthquake", "Plague Wind", "Psychic Vortex", "Enchanted Plate", "Sword of the Ancients", "Ring of Wizardry"],
                    mythic: ["Ancient Dragon", "World Tree", "Leviathan", "Titan of Chaos", "Archangel Avacyn", "Lord of the Undead", "Armageddon", "Force of Will"]
                }
            },
            "Chrono_Clash": {
                name: "Chrono Clash",
                totalCards: 75,
                packSize: 12,
                boosterBoxSize: 30,
                packComposition: { common: 7, uncommon: 3, rare: 1 },
                mythicChance: 1 / 7,
                foilChance: 1 / 5,
                cards: {
                    common: ["Clockwork Beetle", "Time-Worn Cobblestone", "Future Sight Adept", "Past Echoes", "Temporal Rift", "Wasteland Scavenger", "Gear Soldier", "Rusted Bolt", "Fading Memory", "Sandstorm Nomad", "Dune Wanderer", "Scrap Heap", "Bronze Automaton", "Steam-Powered Scout", "Chronovore Mite"],
                    uncommon: ["Time Warden", "Paradox Engine", "Aetherium Tinkerer", "Rewind Clock", "Temporal Anchor", "Future Shock Trooper", "Cogwork Librarian", "Steam Blast", "Accelerated Timeline", "Ancient Ruins Guardian", "Oasis Watcher", "Junk Golem", "Brass Commander", "Power Cell", "Vision of Tomorrow"],
                    rare: ["Master of Moments", "Time Sieve", "The Grand Orrery", "Temporal Distortion", "Lord of the Cogwork", "Future Primeval", "Aeon Chronicler", "Blast from the Past", "Timeline Collapse", "Colossus of the Wastes", "Mirage Mirror", "Scrap Trawler", "Chief of the Foundry", "Energy Conduit", "Glimpse the Unthinkable"],
                    mythic: ["The Time Traveler", "Infinity Engine", "Aeon Wave", "Paradox Haze Lord", "Forge of Futures", "Chronomancer Prime", "Nexus of Fate", "The Great Desert Sphinx"]
                }
            }
        };

        // --- APPLICATION STATE ---
        let state = {
            unopenedPacks: {},
            collection: {},
            selectedSet: Object.keys(TCG_SETS)[0],
        };

        // --- DOM ELEMENTS ---
        const setSelector = document.getElementById('set-selector');
        const collectionSetSelector = document.getElementById('collection-set-selector');
        const buyPackBtn = document.getElementById('buy-pack-btn');
        const buyBoxBtn = document.getElementById('buy-box-btn');
        const unopenedPacksDisplay = document.getElementById('unopened-packs-display');
        const openedPackDisplay = document.getElementById('opened-pack-display');
        const collectionDisplay = document.getElementById('collection-display');
        const collectionProgress = document.getElementById('collection-progress');
        // Modal elements
        const packOpeningModal = document.getElementById('pack-opening-modal');
        const packArtTearable = document.getElementById('pack-art-tearable');
        const packArtSetName = document.getElementById('pack-art-set-name');
        const packArtTearOff = document.getElementById('pack-art-tear-off');
        const packArtSetNameTorn = document.getElementById('pack-art-set-name-torn');


        // --- CORE LOGIC ---

        function initialize() {
            Object.keys(TCG_SETS).forEach(setId => {
                const set = TCG_SETS[setId];
                const option = new Option(set.name, setId);
                const collectionOption = new Option(set.name, setId);
                setSelector.add(option);
                collectionSetSelector.add(collectionOption);
                if (!state.unopenedPacks[setId]) state.unopenedPacks[setId] = 0;
                if (!state.collection[setId]) state.collection[setId] = {};
            });

            setSelector.addEventListener('change', (e) => state.selectedSet = e.target.value);
            collectionSetSelector.addEventListener('change', renderCollection);
            buyPackBtn.addEventListener('click', () => buyPacks(1));
            buyBoxBtn.addEventListener('click', () => buyPacks(TCG_SETS[state.selectedSet].boosterBoxSize));
            
            setupPackTearing();
            
            loadState();
            renderUnopenedPacks();
            renderCollection();
        }

        function buyPacks(amount) {
            state.unopenedPacks[state.selectedSet] += amount;
            renderUnopenedPacks();
            saveState();
        }

        function generatePackContents(setId) {
            const set = TCG_SETS[setId];
            const openedCards = [];
            for (const rarity in set.packComposition) {
                if (rarity === 'rare') continue;
                for (let i = 0; i < set.packComposition[rarity]; i++) {
                    const cardPool = set.cards[rarity];
                    const cardName = cardPool[Math.floor(Math.random() * cardPool.length)];
                    openedCards.push({ name: cardName, rarity: rarity, isFoil: false });
                }
            }
            const isMythic = Math.random() < set.mythicChance;
            const rareSlotRarity = isMythic ? 'mythic' : 'rare';
            const rareSlotPool = set.cards[rareSlotRarity];
            const rareSlotCardName = rareSlotPool[Math.floor(Math.random() * rareSlotPool.length)];
            openedCards.push({ name: rareSlotCardName, rarity: rareSlotRarity, isFoil: false });

            if (Math.random() < set.foilChance) {
                const foilIndex = Math.floor(Math.random() * openedCards.length);
                openedCards[foilIndex].isFoil = true;
            }
            return openedCards;
        }

        function addCardsToCollection(setId, cards) {
            cards.forEach(card => {
                const collectionSet = state.collection[setId];
                if (!collectionSet[card.name]) {
                    collectionSet[card.name] = { count: 0, foilCount: 0 };
                }
                collectionSet[card.name].count++;
                if (card.isFoil) {
                    collectionSet[card.name].foilCount++;
                }
            });
        }
        
        // --- PACK OPENING INTERACTION ---

        function showPackOpeningModal(setId) {
            if (state.unopenedPacks[setId] <= 0) return;
            
            const cards = generatePackContents(setId);
            const setName = TCG_SETS[setId].name;

            packArtSetName.textContent = setName;
            packOpeningModal.style.display = 'flex';
            
            // This property will be used by the tearing logic
            packOpeningModal.currentPack = { setId, cards };
        }

        function setupPackTearing() {
            let isDragging = false;
            let startX = 0;
            const tearThreshold = 100; // pixels to drag before it opens

            const handleDragStart = (clientX) => {
                isDragging = true;
                startX = clientX;
                packArtTearable.style.cursor = 'grabbing';
                // Remove transitions for smooth dragging
                packArtTearable.style.transition = 'none';
                packArtTearOff.style.transition = 'none';
                packArtTearOff.style.transform = 'translateX(0)';
            };

            const handleDragMove = (clientX) => {
                if (!isDragging) return;
                const deltaX = Math.max(0, clientX - startX);
                const tearPercent = Math.min(100, (deltaX / packArtTearable.clientWidth) * 100);

                // The main pack front gets clipped from the left
                packArtTearable.style.clipPath = `inset(0 0 0 ${tearPercent}%)`;
                
                // The torn-off piece only shows the part that's been torn...
                packArtTearOff.style.clipPath = `inset(0 ${100 - tearPercent}% 0 0)`;
                // ...and it moves with the mouse
                packArtTearOff.style.transform = `translateX(${deltaX}px)`;
            };
            
            const handleDragEnd = (clientX) => {
                if (!isDragging) return;
                isDragging = false;
                packArtTearable.style.cursor = 'grab';

                // Add transitions back for smooth animations
                packArtTearable.style.transition = 'clip-path 0.2s ease-out';
                packArtTearOff.style.transition = 'transform 0.3s ease-out, clip-path 0.2s ease-out';

                const deltaX = clientX - startX;
                if (deltaX > tearThreshold) {
                    // SUCCESSFUL TEAR: Animate torn piece flying away
                    packArtTearOff.style.transform = `translateX(${packArtTearable.clientWidth * 1.5}px) rotate(25deg)`;
                    // Animate main pack front disappearing completely
                    packArtTearable.style.clipPath = 'inset(0 0 0 100%)';
                    
                    // After animation, finish the process
                    setTimeout(finishOpening, 300);
                } else {
                    // FAILED TEAR - Reset everything back to start
                    packArtTearable.style.clipPath = 'inset(0 0 0 0)';
                    packArtTearOff.style.clipPath = 'inset(0 100% 0 0)';
                    packArtTearOff.style.transform = 'translateX(0px)';
                }
            };
            
            // Mouse events
            packArtTearable.addEventListener('mousedown', (e) => handleDragStart(e.clientX));
            window.addEventListener('mousemove', (e) => handleDragMove(e.clientX));
            window.addEventListener('mouseup', (e) => handleDragEnd(e.clientX));

            // Touch events
            packArtTearable.addEventListener('touchstart', (e) => handleDragStart(e.touches[0].clientX), { passive: true });
            window.addEventListener('touchmove', (e) => handleDragMove(e.touches[0].clientX), { passive: true });
            window.addEventListener('touchend', (e) => handleDragEnd(e.changedTouches[0].clientX));
        }

        function finishOpening() {
            const { setId, cards } = packOpeningModal.currentPack;
            
            state.unopenedPacks[setId]--;
            addCardsToCollection(setId, cards);

            // Hide modal and reset elements for the next opening
            packOpeningModal.style.display = 'none';
            
            // Reset the visual state of the tearable elements without animation
            packArtTearable.style.transition = 'none';
            packArtTearOff.style.transition = 'none';
            
            packArtTearable.style.clipPath = `inset(0 0 0 0)`;
            packArtTearOff.style.clipPath = `inset(0 100% 0 0)`;
            packArtTearOff.style.transform = 'translateX(0px)';

            // Render cards and update UI
            setTimeout(() => {
                 renderOpenedPack(cards);
                 renderUnopenedPacks();
                 renderCollection();
                 saveState();
            }, 10);
        }
        
        // --- RENDER FUNCTIONS ---
        
        function renderUnopenedPacks() {
            unopenedPacksDisplay.innerHTML = '';
            let totalPacks = Object.values(state.unopenedPacks).reduce((a, b) => a + b, 0);
            
            Object.keys(state.unopenedPacks).forEach(setId => {
                const count = state.unopenedPacks[setId];
                if (count > 0) {
                    const set = TCG_SETS[setId];
                    const packElement = document.createElement('div');
                    packElement.className = 'pack p-4 bg-gray-700 rounded-lg text-center shadow-md';
                    packElement.innerHTML = `<div class="font-bold text-lg">${set.name}</div><div class="text-2xl">${count}x</div><div class="text-sm text-gray-400">Click to Open</div>`;
                    packElement.onclick = () => showPackOpeningModal(setId);
                    unopenedPacksDisplay.appendChild(packElement);
                }
            });

            if (totalPacks === 0) {
                unopenedPacksDisplay.innerHTML = `<p class="text-gray-500">No packs to open. Buy some from a set!</p>`;
            }
        }
        
        function renderOpenedPack(cards) {
            openedPackDisplay.innerHTML = '';
            cards.forEach((card, index) => {
                const cardContainer = document.createElement('div');
                cardContainer.className = 'card-container h-40';
                
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.innerHTML = `
                    <div class="card-face card-back"><div class="card-back-logo">?</div></div>
                    <div class="card-face card-front"></div>
                `;

                cardContainer.appendChild(cardEl);
                openedPackDisplay.appendChild(cardContainer);
                
                // Add staggered animation for cards appearing
                setTimeout(() => {
                    cardContainer.style.opacity = 1;
                    cardContainer.style.transform = 'translateY(0)';
                }, index * 50);

                cardContainer.addEventListener('click', () => {
                    if (cardContainer.classList.contains('flipped')) return;

                    const cardFront = cardEl.querySelector('.card-front');
                    const setId = collectionSetSelector.value; // Assume current set for rarity lookup
                    const rarity = getCardRarity(setId, card.name);

                    cardFront.innerHTML = createCardFaceHTML(card.name, rarity);
                    if (card.isFoil) {
                        cardFront.classList.add('foil');
                    }
                    cardFront.classList.add(`rarity-${rarity}`, 'border-4', 'rounded-lg', 'p-2', 'h-full', 'flex', 'flex-col', 'justify-between', 'bg-gray-800', 'shadow-md');
                    cardContainer.classList.add('flipped');
                }, { once: true });
            });
        }
        
        function renderCollection() {
            const selectedSetId = collectionSetSelector.value;
            if (!selectedSetId) return;

            collectionDisplay.innerHTML = '';
            const set = TCG_SETS[selectedSetId];
            const collectionSet = state.collection[selectedSetId];
            let collectedCount = 0;
            
            const allCardsInSet = [
                ...set.cards.common.map(name => ({name, rarity: 'common'})),
                ...set.cards.uncommon.map(name => ({name, rarity: 'uncommon'})),
                ...set.cards.rare.map(name => ({name, rarity: 'rare'})),
                ...set.cards.mythic.map(name => ({name, rarity: 'mythic'})),
            ];

            allCardsInSet.forEach(cardInfo => {
                const cardData = collectionSet[cardInfo.name];
                const count = cardData ? cardData.count : 0;
                const foilCount = cardData ? cardData.foilCount : 0;
                
                const cardElement = createCollectionCardElement(cardInfo.name, cardInfo.rarity, foilCount > 0, count, foilCount);
                collectionDisplay.appendChild(cardElement);

                if (count > 0) collectedCount++;
            });
            
            const totalSetCards = allCardsInSet.length;
            const percentage = totalSetCards > 0 ? ((collectedCount / totalSetCards) * 100).toFixed(1) : 0;
            collectionProgress.textContent = `${collectedCount} / ${totalSetCards} (${percentage}%)`;
        }
        
        function createCardFaceHTML(name, rarity) {
            return `<div class="font-semibold text-sm leading-tight">${name}</div><div class="text-xs self-end capitalize text-gray-400">${rarity}</div>`;
        }

        function createCollectionCardElement(name, rarity, isFoil, count, foilCount) {
            const element = document.createElement('div');
            const foilClass = isFoil ? 'foil' : '';
            const ownedClass = count === 0 ? 'opacity-40' : '';
            element.className = `card-face relative border-4 rounded-lg p-2 h-40 flex flex-col justify-between bg-gray-800 shadow-md rarity-${rarity} ${foilClass} ${ownedClass}`;
            
            let countDisplay = `<div class="absolute top-1 right-1 bg-gray-900 text-white text-xs font-bold rounded-full px-2 py-1">
                    ${isFoil ? `<span class="text-yellow-400">★${foilCount}</span> / ` : ''} ${count}x
                </div>`;

            element.innerHTML = createCardFaceHTML(name, rarity) + countDisplay;
            return element;
        }
        
        function getCardRarity(setId, cardName) {
            const set = TCG_SETS[setId];
            for (const rarity in set.cards) {
                if (set.cards[rarity].includes(cardName)) return rarity;
            }
            return 'common';
        }

        // --- LOCAL STORAGE ---
        function saveState() {
            localStorage.setItem('tcgSimState', JSON.stringify(state));
        }
        
        function loadState() {
            try {
                const savedState = localStorage.getItem('tcgSimState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    Object.keys(TCG_SETS).forEach(setId => {
                       if (!parsedState.unopenedPacks || typeof parsedState.unopenedPacks[setId] === 'undefined') {
                           if (!parsedState.unopenedPacks) parsedState.unopenedPacks = {};
                           parsedState.unopenedPacks[setId] = 0;
                       }
                       if (!parsedState.collection || !parsedState.collection[setId]) {
                           if (!parsedState.collection) parsedState.collection = {};
                           parsedState.collection[setId] = {};
                       }
                    });
                    state = parsedState;
                }
            } catch (e) {
                console.error("Could not load state from localStorage", e);
            }
        }
        
        // --- START ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>